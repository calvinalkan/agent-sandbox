---
schema_version: 1
id: d5g37g0
status: closed
closed: 2026-01-09T05:28:13Z
blocked-by: [d5g37b0]
created: 2026-01-08T22:46:24Z
type: task
priority: 1
---
# Command Wrappers: wrap-binary Subcommand Implementation

## Background & Context

Per TECHNICAL_STEERING.md:
> **One hidden command** (not in --help, only works inside sandbox):
>
> | Command | Purpose |
> |---------|---------|
> | wrap-binary <cmd> [args...] | Presets: apply rules, exec real binary. Custom: set env var, exec user's script |

The wrap-binary command is the workhorse that implements preset logic and
custom script delegation. It's hidden because it only makes sense inside
the sandbox.

## Rationale

Why a separate command rather than inline bash logic?
1. **Preset complexity:** @git needs to parse git's argument grammar
2. **Consistent interface:** Both presets and custom scripts use same entry point
3. **Tamperproof:** wrap-binary can verify it's inside sandbox before acting
4. **Path resolution:** Can find real binary via convention-based paths

## Implementation Details

```go
// WrapBinaryCmd creates the hidden wrap-binary command
func WrapBinaryCmd() *Command {
    return &Command{
        // Hidden: no entry in main help
        Usage: "wrap-binary [--preset <@name> | --script <path>] <cmd> [args...]",
        Short: "Internal wrapper command (sandbox only)",
        Exec: func(ctx context.Context, stdin io.Reader, stdout, stderr io.Writer, args []string) error {
            // Must be inside sandbox
            if !isInsideSandbox() {
                return fmt.Errorf("wrap-binary can only run inside sandbox")
            }

            // Parse wrapper selection from args (do not load config files inside the sandbox).
            // Exactly one of --preset or --script must be set.
            preset, script, rest, err := parseWrapBinaryArgs(args)
            if err != nil {
                return err
            }
            if len(rest) == 0 {
                return fmt.Errorf("wrap-binary requires command name")
            }

            cmdName := rest[0]
            cmdArgs := rest[1:]

            // Locate real binary via the runtime directory convention:
            //   <selfDir>/real/<cmdName>
            realBinary := findRealBinary(cmdName)

            if preset != "" {
                return execPreset(ctx, preset, cmdName, cmdArgs, realBinary, stdin, stdout, stderr)
            }

            // Custom script: set env var for user's script and exec it.
            env := os.Environ()
            env = append(env, fmt.Sprintf("%s=%s", agentSandboxEnvVarName(cmdName), realBinary))
            return execCustomScript(ctx, script, cmdArgs, env, stdin, stdout, stderr)
        },
    }
}
```

**Real binary location:** Per TECHNICAL_STEERING.md:
> Uses os.Executable() to find its own path, then locates real binary at 
> ../real/<name>

The directory structure in sandbox:
```
/run/<random>/agent-sandbox/binaries/
├── wrap-binary          # agent-sandbox binary
└── real/
    ├── git              # real git binary
    └── npm              # real npm binary
```

**Invocation contract:**
Wrapper scripts should exec the sandbox runtime binary path (not `$PATH`) so `os.Executable()`
resolves to the runtime directory and `../real/<cmd>` exists:
```bash
exec /run/<random>/agent-sandbox/binaries/wrap-binary wrap-binary --preset @git git "$@"
```

## Files to Create
- cmd/agent-sandbox/cmd_wrap_binary.go - wrap-binary command
- cmd/agent-sandbox/cmd_wrap_binary_test.go - tests

## Key Invariants
- Only works inside sandbox (errors otherwise)
- Not shown in --help
- Finds real binary via path convention
- For presets: applies rules then execs
- For custom: sets env var then execs user script

## Acceptance Criteria

1. wrap-binary command exists but not in main help
2. Errors if run outside sandbox
3. Parses command name from first non-flag argument
4. For presets: `--preset @git` applies preset rules before exec
5. For custom scripts: `--script <path>` sets `AGENT_SANDBOX_<CMD>` env var then execs the user script
6. Finds real binary at predictable path
7. Execs real binary (for presets) or user script (for custom)
8. Passes all remaining args to target command

**Unit tests (in cmd_wrap_binary_test.go):**
9. findRealBinary() correctly locates binary at ../real/<name> relative to executable
10. Env var AGENT_SANDBOX_<CMD> is correctly formatted

**E2E tests (deferred to d5g38j8):**
11. Full wrap-binary behavior inside actual sandbox
12. Inside-sandbox check actually works (not faked)
