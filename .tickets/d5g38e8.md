---
schema_version: 1
id: d5g38e8
status: open
blocked-by: [d5g389g]
created: 2026-01-08T22:48:25Z
type: task
priority: 2
---
# E2E Tests: Filesystem Access Verification

## Background & Context

Per TECHNICAL_STEERING.md Testing section:
> **E2E tests with real bwrap.** Actually run commands in the sandbox and 
> verify behavior - what's accessible, what's blocked, what's read-only.
>
> **Simple test programs.** Use bash, cat, touch, ls - whatever is easiest 
> to verify a behavior. Not Go binaries (they need compilation).

These tests verify the core security guarantees actually work.

## Rationale

Unit tests verify individual components, but E2E tests verify the entire
system works as intended. We must prove that:
- Read-only paths are actually read-only
- Excluded paths are actually invisible
- Writable paths are actually writable
- The sandbox doesn't break legitimate operations

## Implementation Details

**Note:** These tests can use `Run()` (not `RunBinary()`) because they run 
external commands (`cat`, `touch`, `ls`) inside the sandbox, not agent-sandbox
itself. The sandbox just needs to work; we don't need the binary mounted inside.

Test structure using table tests:

```go
func Test_Sandbox_Filesystem_Access(t *testing.T) {
    tests := []struct {
        name     string
        setup    func(t *testing.T) string // Returns temp dir with test files
        config   string                     // Config JSON
        command  []string                   // Command to run in sandbox
        wantErr  bool
        check    func(t *testing.T, stdout, stderr string) // Verify output
    }{
        {
            name: "can read from ro path",
            setup: func(t *testing.T) string {
                dir := t.TempDir()
                os.WriteFile(filepath.Join(dir, "file.txt"), []byte("content"), 0644)
                return dir
            },
            config:  `{"filesystem": {"ro": ["%s"]}}`,
            command: []string{"cat", "%s/file.txt"},
            check:   func(t *testing.T, stdout, _ string) {
                if stdout != "content" {
                    t.Errorf("expected content, got %q", stdout)
                }
            },
        },
        {
            name: "cannot write to ro path",
            // ... setup and config ...
            command: []string{"touch", "%s/newfile.txt"},
            wantErr: true,
            check: func(t *testing.T, _, stderr string) {
                if !strings.Contains(stderr, "Read-only") {
                    t.Errorf("expected read-only error, got %q", stderr)
                }
            },
        },
        {
            name: "cannot see excluded path",
            // ...
            command: []string{"ls", "%s"},
            check: func(t *testing.T, stdout, _ string) {
                if strings.Contains(stdout, "secret") {
                    t.Errorf("excluded file visible in ls output")
                }
            },
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // ... run agent-sandbox with config and command ...
        })
    }
}
```

**Test categories:**
1. Read-only enforcement (can read, can't write)
2. Exclude enforcement (can't see, can't read)
3. Writable paths (can read and write)
4. Specificity (more specific path wins)
5. Nested paths (child path overrides parent)

## Files to Create
- cmd/agent-sandbox/e2e_filesystem_test.go - E2E filesystem tests

## Key Invariants
- Tests use real bwrap (not mocked)
- Tests create temp directories with known contents
- Tests verify via stdout/stderr from sandboxed commands
- Tests clean up after themselves
- Tests skip if bwrap not available

## Acceptance Criteria

1. Test verifies ro paths: can read
2. Test verifies ro paths: cannot write (error)
3. Test verifies excluded paths: cannot ls
4. Test verifies excluded paths: cannot cat
5. Test verifies rw paths: can read and write
6. Test verifies specificity: ro child of rw parent is ro
7. Test verifies specificity: rw child of ro parent is rw
8. Tests skip gracefully if bwrap not installed
9. All tests pass with current implementation
