---
schema_version: 1
id: d5g37p0
status: open
blocked-by: [d5g37g0]
created: 2026-01-08T22:46:48Z
type: task
priority: 1
---
# Command Wrappers: @git Preset Implementation

## Background & Context

Per SPEC.md, @git is the only built-in command preset. It blocks dangerous git operations:

| Blocked | Reason | Alternative |
|---------|--------|-------------|
| git checkout | Can discard uncommitted changes | git switch for branches |
| git restore | Discards uncommitted changes | Commit or stash first |
| git reset --hard | Discards commits and changes | git reset --soft |
| git clean -f | Deletes untracked files | Manual review |
| git commit --no-verify | Bypasses safety hooks | Fix hook issues |
| git stash drop | Permanently deletes stash | Keep stashes |
| git stash clear | Deletes all stashes | Export first |
| git stash pop | Can lose stash on conflict | git stash apply |
| git branch -D | Force deletes unmerged branch | git branch -d |
| git push --force | Rewrites remote history | --force-with-lease |

> The wrapper properly parses git's global flags (e.g., -C, --no-pager) to 
> correctly identify subcommands regardless of flag position.

## Rationale

Git operations can cause irreversible data loss. The @git preset prevents
agents from accidentally (or maliciously) destroying work. It encourages
safer alternatives that preserve history and allow recovery.

## Implementation Details

Git argument parsing is complex due to global flags:
```bash
git -C /path checkout main      # -C is global, checkout is subcommand
git --no-pager log --oneline    # --no-pager is global, log is subcommand
git -c user.name=x commit       # -c is global, commit is subcommand
```

```go
// GitGlobalFlags are flags that appear before the subcommand
var GitGlobalFlags = map[string]bool{
    "-C": true, "-c": true, "--exec-path": true, "--git-dir": true,
    "--work-tree": true, "--namespace": true, "--super-prefix": true,
    "--bare": true, "--no-replace-objects": true, "--literal-pathspecs": true,
    "--no-literal-pathspecs": true, "--glob-pathspecs": true,
    "--noglob-pathspecs": true, "--icase-pathspecs": true,
    "--no-optional-locks": true, "-p": true, "--paginate": true,
    "-P": true, "--no-pager": true, "--help": true, "--version": true,
}

func ParseGitCommand(args []string) (subcommand string, subArgs []string, err error) {
    i := 0
    for i < len(args) {
        arg := args[i]
        
        if !strings.HasPrefix(arg, "-") {
            // First non-flag is the subcommand
            return arg, args[i+1:], nil
        }
        
        // Check if this flag takes a value
        if GitGlobalFlags[arg] && needsValue(arg) {
            i += 2 // Skip flag and value
        } else {
            i++
        }
    }
    
    return "", nil, errors.New("no git subcommand found")
}

func ValidateGitCommand(subcommand string, subArgs []string) error {
    switch subcommand {
    case "checkout":
        return fmt.Errorf("git checkout blocked: use 'git switch' for branches")
    case "restore":
        return fmt.Errorf("git restore blocked: commit or stash changes first")
    // ... etc for each blocked command
    case "reset":
        if contains(subArgs, "--hard") {
            return fmt.Errorf("git reset --hard blocked: use 'git reset --soft'")
        }
    // ... etc for commands with specific flag checks
    }
    
    return nil // Command allowed
}
```

## Files to Create
- cmd/agent-sandbox/git_preset.go - @git validation logic
- cmd/agent-sandbox/git_preset_test.go - comprehensive tests

## Key Invariants
- Must correctly parse global flags to find subcommand
- Each blocked command has clear, actionable error message
- Partial blocks (like reset --hard but not reset --soft) work correctly
- Git alias commands are NOT blocked (they're user-defined)
- Tests cover all blocked commands and edge cases

## Acceptance Criteria

1. Blocks: checkout, restore, reset --hard, clean -f
2. Blocks: commit --no-verify, stash drop/clear/pop
3. Blocks: branch -D, push --force
4. Allows: switch, reset --soft, stash apply, branch -d
5. Allows: push --force-with-lease, status, diff, log, etc.
6. Error messages include suggested alternatives
7. Correctly parses global flags (-C, --no-pager, etc.)
8. Works with flags in any order
9. Tests for each blocked command
10. Tests for global flag parsing edge cases
