---
schema_version: 1
id: d5g361g
status: open
blocked-by: [d5g35wg]
created: 2026-01-08T22:43:18Z
type: task
priority: 1
---
# Path Resolution: Glob Pattern Expansion

## Background & Context

Per SPEC.md Path Patterns section:

> **Glob support:**
> - * matches any characters within a single path segment (native Go filepath.Glob)
> - Multiple wildcards allowed: src/*/*/config.json
> - No ** recursive glob support

Globs expand at sandbox startup to existing paths only.

## Rationale

Globs allow flexible protection patterns:
- "packages/*/biome.json" - protect biome.json in all packages
- "config/*/secrets.json" - protect secrets files in config subdirs
- ".env*" - protect .env, .env.local, .env.production, etc.

Globs that match nothing are silently skipped (per SPEC error conditions).

## Implementation Details

```go
// ExpandGlob expands a path pattern with wildcards to matching files
// Returns empty slice if pattern matches nothing (no error)
func ExpandGlob(pattern string) ([]string, error) {
    // filepath.Glob uses filepath.Match, which supports: *, ?, and [] character classes.
    if !strings.ContainsAny(pattern, "*?[") {
        // Not a glob - return as-is (existence checked separately)
        return []string{pattern}, nil
    }
    
    matches, err := filepath.Glob(pattern)
    if err != nil {
        // Invalid glob pattern
        return nil, fmt.Errorf("invalid glob pattern %q: %w", pattern, err)
    }
    
    // Empty matches = pattern is valid but matches nothing
    // Per SPEC: "Glob matches nothing â†’ Skip silently"
    return matches, nil
}
```

**Integration with path resolution:**
1. First resolve ~ and relative paths to absolute
2. Then expand globs
3. Non-glob paths get existence checked separately

**Symlink Handling:**
Per SPEC hardcoded behavior:
> Symlink resolution: Paths are resolved before mounting

So after glob expansion, we should resolve symlinks:
```go
resolved, err := filepath.EvalSymlinks(path)
```

## Files to Modify
- cmd/agent-sandbox/path.go - add ExpandGlob function
- cmd/agent-sandbox/path_test.go - test glob expansion

## Key Invariants
- Globs use Go's filepath.Glob semantics (no **; supports *, ?, and [] like filepath.Match)
- Empty glob results are OK (silently skipped)
- Invalid glob patterns return errors (e.g., malformed brackets)
- Symlinks in results should be resolved to real paths
- Order of results from filepath.Glob is deterministic (sorted)

## Acceptance Criteria

1. Patterns with glob metacharacters (*, ?, or []) are expanded via filepath.Glob
2. Patterns without any glob metacharacters are returned as-is
3. Globs matching nothing return empty slice (no error)
4. Invalid glob patterns (e.g., "[") return error
5. Multiple wildcards work (src/*/*/file)
6. Results are sorted (filepath.Glob behavior)
7. Symlinks in glob results are resolved
8. Tests with actual filesystem (temp dirs with files)
