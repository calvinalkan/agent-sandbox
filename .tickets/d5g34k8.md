---
schema_version: 1
id: d5g34k8
status: closed
closed: 2026-01-09T01:16:05Z
blocked-by: []
created: 2026-01-08T22:40:13Z
type: task
priority: 1
---
# Platform Prerequisites & Validation

## Background & Context

agent-sandbox is a Linux-only tool that wraps bubblewrap (bwrap). Before any sandbox 
operations can proceed, we must validate the runtime environment. This is the first 
line of defense and provides clear error messages to users on unsupported platforms.

## Rationale

Per SPEC.md error conditions:
- "Running as root → Error, refuse to run" (security risk)
- "Not on Linux → Error, exit"  
- "bwrap not installed → Error, exit"

These checks must happen BEFORE any sandbox operations. They're fundamental gatekeeping.

## Implementation Details

1. **Linux check**: Use Go's runtime.GOOS
2. **Root check**: Use os.Getuid() == 0
3. **bwrap check**: exec.LookPath("bwrap") 

Checks should run at the start of the exec command, NOT in Run() (so check command 
works anywhere for testing).

Per TECHNICAL_STEERING.md: "Actionable hints when possible" - error messages should 
include installation instructions for bwrap.

## Files to Modify
- cmd/agent-sandbox/cmd_exec.go - add validation at start of Exec function
- cmd/agent-sandbox/cmd_exec_test.go - test all error cases

## Key Invariants
- These checks MUST run before any bwrap invocation
- Error messages must be clear and actionable
- Tests should use mocking/build tags for platform-specific tests

## Acceptance Criteria

1. Running as root exits with error: "agent-sandbox cannot run as root" 
2. Running on non-Linux exits with error mentioning "Linux required"
3. Missing bwrap exits with error including install hint (e.g., "apt install bubblewrap")
4. All checks have corresponding tests
5. Checks only run for exec command, not check command
