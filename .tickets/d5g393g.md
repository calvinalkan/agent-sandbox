---
schema_version: 1
id: d5g393g
status: open
blocked-by: [d5g3538]
created: 2026-01-08T22:49:50Z
type: task
priority: 1
---
# Edge Cases: Home Directory Validation

## Background & Context

Per SPEC.md Error Conditions:
> Home directory not found (with @base) â†’ Error, exit

The @base preset references the home directory (~). If home can't be determined,
the sandbox would have undefined behavior.

## Rationale

Many paths depend on home directory expansion:
- ~/.ssh (excluded secrets)
- ~/.config (global config)
- ~/go (Go cache)
- etc.

If $HOME is not set or the directory doesn't exist, we should fail clearly
rather than silently misbehave.

## Implementation Details

```go
func GetHomeDir(env map[string]string) (string, error) {
    // Try env first (respect container overrides)
    if home := env["HOME"]; home != "" {
        // Verify it exists
        info, err := os.Stat(home)
        if err != nil {
            return "", fmt.Errorf("home directory %s (from $HOME) does not exist: %w", home, err)
        }
        if !info.IsDir() {
            return "", fmt.Errorf("home directory %s (from $HOME) is not a directory", home)
        }
        return home, nil
    }
    
    // Fall back to os.UserHomeDir()
    home, err := os.UserHomeDir()
    if err != nil {
        return "", fmt.Errorf("cannot determine home directory: %w (set $HOME environment variable)", err)
    }
    
    return home, nil
}
```

**When to check:**
- Early in exec command, before any path resolution
- Only if @base or any preset using home paths is active

**Special cases:**
- Container environments with custom HOME
- SSH sessions with different HOME
- Root user (we error anyway, but check before home check)

## Files to Modify
- cmd/agent-sandbox/cmd_exec.go - add home validation
- cmd/agent-sandbox/cmd_exec_test.go - tests (mock env)

## Key Invariants
- Check happens early (before preset expansion)
- Clear error if HOME not set
- Clear error if HOME doesn't exist
- Uses env map, not os.Getenv (for testing)

## Acceptance Criteria

1. Error if $HOME not set and os.UserHomeDir fails
2. Error if $HOME set but directory doesn't exist
3. Error if $HOME points to a file, not directory
4. Uses env map from Run() (not os.Getenv)
5. Error message suggests setting $HOME
6. Tests with mocked env vars
7. Normal case works when HOME is valid
