---
schema_version: 1
id: d5g34y0
status: closed
closed: 2026-01-09T02:00:28Z
blocked-by: [d5g34q0]
created: 2026-01-08T22:40:56Z
type: task
priority: 1
---
# Config: CLI Flag Integration for Exec Command

## Background & Context

The exec command defines flags (--network, --docker, --ro, --rw, --exclude, --cmd)
but these are not yet integrated with the Config struct. Per SPEC.md, CLI flags have
highest priority in the config merge chain:

> **Loading order:** defaults → global → project → CLI flags

The exec command currently parses these flags but doesn't merge them into the config.

## Rationale

Users need CLI overrides to work. For example:
- agent-sandbox --network=false npm install  (disable network for this run)
- agent-sandbox --ro src/auth/ node build.js (add protection for this run)
- agent-sandbox --cmd git=true git checkout main (remove git wrapper for this run)

Without this integration, CLI flags are effectively ignored.

## Implementation Details

### 1) Ensure exec flags are accepted in *implicit exec* mode

Per SPEC command structure, users can run:
```bash
agent-sandbox --network=false npm install
```
even without explicitly writing `exec`.

Today, global flag parsing errors on `--network` because it is not a global flag.
We need Run() to:
1. Parse only *global* flags (`--cwd`, `--config`, `--help`, `--version`) while tolerating exec flags.
2. Dispatch to `exec` (implicit or explicit) with the remaining args so the exec FlagSet can parse `--network`, `--docker`, `--ro`, etc.

One approach: use `pflag.ParseErrorsWhitelist{UnknownFlags: true}` on the global FlagSet, then hand the remaining args to the command FlagSet.

### 2) Do not load config when help is requested / for `check`

Per SPEC: `--help` may appear anywhere and should show help with **no action**. That implies:
- `agent-sandbox --help` should not fail because config is invalid.
- `agent-sandbox check` should not depend on config loading.

So config loading should happen only for the exec path (implicit or explicit), and be skipped for:
- global help
- `check`

### 3) Apply exec CLI flags onto the resolved config (highest precedence)

After config loading in `cmd_exec.go`, apply CLI flag values:

```go
// Example structure
func applyCliFlags(cfg *Config, flags *flag.FlagSet) *Config {
    result := *cfg
    
    if flags.Changed("network") {
        val, _ := flags.GetBool("network")
        result.Network = &val
    }
    
    if flags.Changed("docker") {
        val, _ := flags.GetBool("docker")
        result.Docker = &val
    }
    
    // Concatenate CLI paths to config paths
    if roVals, _ := flags.GetStringArray("ro"); len(roVals) > 0 {
        result.Filesystem.Ro = append(result.Filesystem.Ro, roVals...)
    }
    // ... etc for rw, exclude
    
    // Parse --cmd KEY=VALUE flags and merge into commands map
    // ...
}
```

Also ensure `cmd_exec.go` actually defines the `--cmd` flag per SPEC:
- repeatable `--cmd KEY=VALUE`
- allow comma-separated list in a single flag value: `--cmd git=true,rm=false`

Parsing rules for `--cmd` values:
- `VALUE` of `true` / `false` → boolean command rule
- `VALUE` starting with `@` → preset rule
- otherwise → script path rule

`--cmd` should merge by key into `cfg.Commands`, overriding prior layers for that key.

## Files to Modify
- cmd/agent-sandbox/run.go - tolerate exec flags in implicit exec mode; avoid config load on help/check
- cmd/agent-sandbox/cmd_exec.go - add `--cmd` flag + CLI flag application
- cmd/agent-sandbox/cmd_exec_test.go - test flag override behavior

## Key Invariants
- CLI flags only apply if explicitly set (use flags.Changed())
- Boolean flags must support --flag and --flag=false syntax (pflag handles this)
- Path arrays concatenate (CLI paths added after config paths)
- --cmd values merge into commands map (overriding existing keys)

## Acceptance Criteria

1. --network=false overrides config network setting
2. --docker=true overrides config docker setting
3. --ro paths are appended to config ro paths
4. --rw paths are appended to config rw paths
5. --exclude paths are appended to config exclude paths
6. --cmd KEY=VALUE entries merge into commands map
7. Multiple --cmd flags work (repeated or comma-separated)
8. Unset CLI flags don't override config values
9. `agent-sandbox --network=false <cmd>` works in implicit exec mode (no unknown-flag error)
10. `agent-sandbox --help` does not load/validate config (help always works)
11. Tests verify all override scenarios
