---
schema_version: 1
id: d5g3900
status: open
blocked-by: [d5g36br]
created: 2026-01-08T22:49:36Z
type: task
priority: 1
---
# Edge Cases: PWD Inside Excluded Path Detection

## Background & Context

Per SPEC.md Error Conditions:
> $PWD inside excluded path â†’ Error, exit

If the working directory is inside an excluded path, the sandbox would be
unusable (can't access PWD). We must detect this early and error.

## Rationale

This is a configuration error that would result in a broken sandbox. Early
detection with a clear message saves debugging time.

Example scenario:
- User has exclude: ["~/code/secret-project"]
- User is in ~/code/secret-project/subdir
- Sandbox would make their current directory invisible

## Implementation Details

Check during path resolution, after specificity:

```go
func ValidateEffectivePaths(paths []ResolvedPath, workDir string) error {
    workDir, err := filepath.EvalSymlinks(workDir)
    if err != nil {
        return err
    }
    
    for _, p := range paths {
        if p.Access != "exclude" {
            continue
        }
        
        // Check if workDir is under excluded path
        if workDir == p.Resolved || strings.HasPrefix(workDir, p.Resolved+string(filepath.Separator)) {
            return fmt.Errorf("working directory %s is inside excluded path %s: change directory or remove exclusion", workDir, p.Resolved)
        }
    }
    
    return nil
}
```

**Also check:**
- PWD under read-only path is OK (can still read)
- PWD equals excluded path exactly (edge case)
- Symlinked paths (resolve both before comparing)

## Files to Modify
- cmd/agent-sandbox/cmd_exec.go - add validation
- cmd/agent-sandbox/cmd_exec_test.go - tests

## Key Invariants
- Error before bwrap execution (fail fast)
- Clear error message with fix suggestion
- Handles symlinks in both paths
- Exact match and prefix match both detected

## Acceptance Criteria

1. Error if PWD exactly matches excluded path
2. Error if PWD is subdirectory of excluded path
3. No error if PWD is under read-only path
4. No error if PWD is under read-write path
5. Symlinks resolved before comparison
6. Error message includes both paths
7. Error message suggests fix (change dir or remove exclusion)
8. Tests verify all scenarios
