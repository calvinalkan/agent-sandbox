---
schema_version: 1
id: d5g34q0
status: open
blocked-by: []
created: 2026-01-08T22:40:28Z
type: task
priority: 1
---
# Config: Add Commands Field Support

## Background & Context

The SPEC defines a "commands" configuration field for command wrapper settings:
```jsonc
{
  "commands": {
    "git": "@git",     // use built-in wrapper
    "rm": false,       // block entirely
    "npm": true,       // raw command (remove wrapper)
    "curl": "~/bin/curl-wrapper"  // custom wrapper script
  }
}
```

The current Config struct only has Network, Docker, and Filesystem. We need to add
the Commands map for wrapper configuration.

## Rationale

Command wrappers are a key safety feature that prevents destructive operations. The
config layer must support this field for the wrapper system to work. This is a 
prerequisite for all command wrapper functionality.

## Implementation Details

Add to Config struct:
```go
type Config struct {
    // ... existing fields ...
    Commands map[string]CommandRule `json:"commands,omitempty"`
}
```

**Important:** Per SPEC, command values are a *union* of boolean and string:
- `"@preset"` (string) → built-in smart wrapper
- `"path"` (string) → custom wrapper script path
- `true` (boolean) → raw command (no wrapper)
- `false` (boolean) → block entirely

The mergeConfigs function needs updating to properly merge command maps (later 
values override earlier for same key, per SPEC merge rules).

Suggested representation:
```go
type CommandRuleKind int

const (
	CommandRuleUnset CommandRuleKind = iota
	CommandRuleRaw                 // true
	CommandRuleBlock               // false
	CommandRulePreset              // "@git"
	CommandRuleScript              // "/path/to/script"
)

type CommandRule struct {
	Kind  CommandRuleKind
	Value string // used for Preset/Script
}

func (r *CommandRule) UnmarshalJSON(b []byte) error {
	// Accept bool or string; reject other JSON types.
	// For string values: strings.HasPrefix(v, "@") => Preset, else Script.
}
```

Default commands per SPEC:
```go
Commands: map[string]CommandRule{
	"git": {Kind: CommandRulePreset, Value: "@git"},
}
```

## Files to Modify
- cmd/agent-sandbox/config.go - add Commands field, update DefaultConfig, update merge
- cmd/agent-sandbox/config_test.go - test parsing and merging

## Key Invariants
- Empty commands map in override should NOT clear base commands (only specified keys override)
- Must support all value types: "@preset", true, false, "/path/to/script"
- Default must include git: "@git"

## Acceptance Criteria

1. Config struct has a Commands map field that can represent bool + string values
2. DefaultConfig() includes {"git": "@git"} (as a preset rule)
3. Config files with "commands" parse correctly for:
   - bool true/false
   - string "@preset"
   - string "path"
4. mergeConfigs merges command maps by key (later layers override earlier keys)
5. Empty/omitted commands map in override preserves base commands
6. Tests cover: parsing, merging, and default values
