---
schema_version: 1
id: d5g3710
status: closed
closed: 2026-01-09T05:11:36Z
blocked-by: [d5g36gr]
created: 2026-01-08T22:45:24Z
type: task
priority: 1
---
# Debug Output: Verbose Sandbox Startup Logging

## Background & Context

Per SPEC.md Debug Output section:
> When --debug is enabled, prints to stderr during sandbox startup:
> - Config files found and loaded (with paths)
> - Config merge steps
> - Path and glob resolution results
> - Final resolved paths with access levels
> - Command wrapper setup
> - Generated bwrap arguments
>
> This does not affect output from the sandboxed process itself.

Per TECHNICAL_STEERING.md:
> Debug output should help diagnose "why did it do X" without flooding the terminal.

## Rationale

When something doesn't work as expected, users need insight into:
- Which config files were loaded?
- How were configs merged?
- Why is this path read-only/excluded?
- What bwrap arguments were generated?

Debug output answers these questions without requiring --dry-run.

## Implementation Details

Create a debug logger that can be enabled/disabled:

```go
// DebugLogger provides structured debug output
type DebugLogger struct {
    enabled bool
    output  io.Writer
}

func (d *DebugLogger) Section(name string) {
    if !d.enabled { return }
    fmt.Fprintf(d.output, "\n=== %s ===\n", name)
}

func (d *DebugLogger) Log(format string, args ...interface{}) {
    if !d.enabled { return }
    fmt.Fprintf(d.output, format+"\n", args...)
}

func (d *DebugLogger) Path(original, resolved, access, source string) {
    if !d.enabled { return }
    fmt.Fprintf(d.output, "  %s -> %s [%s] (from %s)\n", 
        original, resolved, access, source)
}
```

**Output structure:**
```
=== Config Loading ===
  Global config: /home/user/.config/agent-sandbox/config.json
  Project config: /home/user/project/.agent-sandbox.jsonc

=== Config Merge ===
  network: true (default)
  docker: false (default)
  filesystem.presets: ["!@lint/python"] (project)

=== Preset Expansion ===
  Applied presets: @base, @caches, @git, @lint/ts, @lint/go
  Removed presets: @lint/python

=== Path Resolution ===
  ~/.ssh -> /home/user/.ssh [exclude] (from @base)
  .git/hooks -> /home/user/project/.git/hooks [ro] (from @git)
  ...

=== Command Wrappers ===
  git: @git (smart wrapper)
  
=== Generated bwrap Arguments ===
  bwrap --ro-bind / / --dev /dev ...
```

## Files to Create
- cmd/agent-sandbox/debug.go - DebugLogger
- cmd/agent-sandbox/debug_test.go - tests

## Key Invariants
- Debug output goes to stderr (not stdout)
- Disabled by default, enabled with --debug
- Doesn't interfere with sandboxed process output
- Structured sections for easy reading
- Shows full resolution chain (original → resolved)

## Acceptance Criteria

1. --debug enables verbose output to stderr
2. Shows config files found and loaded
3. Shows config merge decisions
4. Shows preset expansion (applied and removed)
5. Shows path resolution (original → resolved with access level)
6. Shows command wrapper setup
7. Shows final bwrap arguments
8. Output is structured with clear sections
9. Disabled by default (no output without --debug)
10. Doesn't interfere with sandboxed process stdout/stderr
