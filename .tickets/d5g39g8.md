---
schema_version: 1
id: d5g39g8
status: closed
closed: 2026-01-09T03:34:42Z
blocked-by: []
created: 2026-01-08T22:50:41Z
type: task
priority: 1
---
# Testing: Test Helper Infrastructure

## Background & Context

Per TECHNICAL_STEERING.md:
> **Test against the real CLI.** The primary test interface is Run() with 
> real arguments.
>
> **Test helpers** in testing_test.go provide a CLI struct that wraps Run() 
> for convenient test setup.

The existing testing_test.go has basic infrastructure. This task extends it
for comprehensive testing needs.

## Rationale

Good test helpers make tests:
- Easier to write
- More readable
- More consistent
- Faster to debug

## Implementation Details

We already have a `CLI` test helper in `cmd/agent-sandbox/testing_test.go` that wraps `Run()`.
This ticket should **extend the existing helper** (not introduce a new parallel helper type).

Improvements needed for upcoming E2E tests:
- Seed `CLI.Env` with a reasonable default baseline (at least `HOME` and `PATH`) so sandboxed commands can run without every test hand-authoring env.
- Add skip helpers used across E2E tests: `RequireLinux`, `RequireBwrap`, `RequireGit`, `RequireDocker`.
- Add a build+exec helper for the cases where tests must run the real `agent-sandbox` binary (not the `go test` harness binary).

## Binary-Level Testing

Some tests CANNOT use `Run()` and need the actual compiled binary:
- `agent-sandbox check` inside a sandbox (binary must be mounted)
- Command wrappers calling the sandbox runtime `wrap-binary` subcommand
- Nested sandbox scenarios

**Strategy: Build once in TestMain, use in tests**

```go
var testBinary string // Set by TestMain

func TestMain(m *testing.M) {
    // Build the binary once for all tests
    tmpDir, err := os.MkdirTemp("", "agent-sandbox-test-")
    if err != nil {
        log.Fatal(err)
    }
    defer os.RemoveAll(tmpDir)
    
    testBinary = filepath.Join(tmpDir, "agent-sandbox")
    cmd := exec.Command("go", "build", "-o", testBinary, ".")
    cmd.Stderr = os.Stderr
    if err := cmd.Run(); err != nil {
        log.Fatalf("failed to build test binary: %v", err)
    }
    
    os.Exit(m.Run())
}

// BinaryPath returns path to compiled binary, skips if not available
func BinaryPath(t *testing.T) string {
    t.Helper()
    if testBinary == "" {
        t.Skip("test binary not built (run via go test, not individual test)")
    }
    return testBinary
}

// RunBinary executes the compiled binary (for tests needing real binary)
func RunBinary(t *testing.T, args ...string) (stdout, stderr string, exitCode int) {
    t.Helper()
    binary := BinaryPath(t)
    
    var outBuf, errBuf bytes.Buffer
    cmd := exec.Command(binary, args...)
    cmd.Stdout = &outBuf
    cmd.Stderr = &errBuf
    
    err := cmd.Run()
    exitCode = 0
    if exitErr, ok := err.(*exec.ExitError); ok {
        exitCode = exitErr.ExitCode()
    } else if err != nil {
        t.Fatalf("failed to run binary: %v", err)
    }
    
    return outBuf.String(), errBuf.String(), exitCode
}
```

**Example: Testing check command inside sandbox**
```go
func TestCheckInsideSandbox(t *testing.T) {
    RequireBwrap(t)
    
    // Run: agent-sandbox exec -- agent-sandbox check
    stdout, stderr, exit := RunBinary(t, "exec", "--", "/usr/bin/agent-sandbox", "check")
    
    if exit != 0 {
        t.Errorf("expected exit 0 inside sandbox, got %d: %s", exit, stderr)
    }
    if !strings.Contains(stdout, "inside sandbox") {
        t.Errorf("expected 'inside sandbox', got: %s", stdout)
    }
}
```

## Files to Modify
- cmd/agent-sandbox/testing_test.go - extend helpers

## Key Invariants
- `CLI` uses `Run()` for fast tests (no process spawn)
- `RunBinary()` uses a compiled `agent-sandbox` binary for tests that need it
- Binary built once per test run in TestMain
- Environment isolation via env map
- Temp directories cleaned up via t.TempDir()
- Skip helpers for platform/dependency checks

## Acceptance Criteria

**Run()-based helpers:**
1. `CLI` has sensible default env (HOME/PATH)
2. Helper methods cover common patterns (workdir, env overrides)
3. Temp project helpers create projects with config files

**Binary-based helpers:**
4. TestMain builds binary once
5. BinaryPath() returns path, skips if not available
6. RunBinary() executes binary and captures output

**Skip helpers:**
7. RequireBwrap skips tests when bwrap unavailable
8. RequireLinux skips tests when not on Linux

**General:**
9. All helpers tested
10. Existing tests converted to use new helpers (where beneficial)
