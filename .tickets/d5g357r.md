---
schema_version: 1
id: d5g357r
status: closed
closed: 2026-01-09T02:05:48Z
blocked-by: [d5g3538]
created: 2026-01-08T22:41:35Z
type: task
priority: 1
---
# Presets: Implement @base Preset

## Background & Context

The @base preset is the foundation of the sandbox. Per SPEC.md:

> @base: Core sandbox: working directory writable, home protected (new files allowed,
> existing protected), temp writable, agent configs writable, secrets excluded 
> (~/.ssh, ~/.gnupg, ~/.aws), sandbox config protected

This is the most complex preset as it establishes the core security model.

## Rationale

The @base preset provides sensible defaults that:
1. Let agents work in the current project (rw: workDir)
2. Protect existing home directory files from modification
3. Allow writing to temp directories
4. Protect critical secrets from being read
5. Protect the sandbox config itself from modification

## Implementation Details

The @base preset should resolve to:

**Read-Write (rw):**
- WorkDir (effective cwd from config)
- /tmp (system temp)

**Read-Only (ro):**
- ~/ (home directory - protects existing files)
- Project config files in WorkDir (if present):
  - <WorkDir>/.agent-sandbox.json
  - <WorkDir>/.agent-sandbox.jsonc
- Any config files that were actually loaded (ctx.LoadedConfigPaths), including:
  - Global config (if present)
  - Explicit `--config` file (when used)

**Exclude:**
- ~/.ssh (SSH keys)
- ~/.gnupg (GPG keys)
- ~/.aws (AWS credentials)

Note: avoid excluding additional auth stores (e.g., `~/.config/gh`, `~/.kube`, `~/.netrc`) by default.
They can be added via user global config if desired; excluding them by default can break legitimate tooling.

Note: "home protected (new files allowed, existing protected)" means:
- Home is ro-bind, so existing files can't be modified
- But workDir (inside home typically) is rw, allowing work
- The specificity rules handle overlapping paths

**Function signature:** `func(ctx PresetContext, disabled map[string]bool) PresetPaths`
Note: @base is a simple preset, so it ignores the `disabled` parameter.

## Files to Modify
- cmd/agent-sandbox/preset.go - implement @base Resolve function
- cmd/agent-sandbox/preset_test.go - test @base resolution

## Key Invariants
- WorkDir MUST be writable (or agents can't do anything)
- Secrets MUST be excluded (not just ro - shouldn't be readable at all)
- Config files MUST be read-only (prevent config tampering)
- Must handle case where workDir is outside home

## Acceptance Criteria

1. @base.Resolve() returns correct ro paths (home + config file paths)
2. @base.Resolve() returns correct rw paths (workDir, /tmp)
3. @base.Resolve() returns correct exclude paths (ssh, gnupg, aws)
4. Paths use absolute form (after context resolution)
5. Works when workDir is inside home directory
6. Works when workDir is outside home directory
7. Config file paths are correctly derived from ctx.WorkDir and ctx.LoadedConfigPaths
8. Tests verify all path categories
