---
schema_version: 1
id: d5g3538
status: closed
closed: 2026-01-09T02:03:22Z
blocked-by: []
created: 2026-01-08T22:41:17Z
type: task
priority: 1
---
# Presets: Define Preset Data Structures and Registry

## Background & Context

Filesystem presets are named configurations that expand to path lists. Per SPEC.md:

| Preset | Description |
|--------|-------------|
| @base | Core sandbox: working directory writable, home protected, temp writable, etc. |
| @caches | Build tool caches writable (~/.cache, ~/.bun, ~/go, ~/.npm, ~/.cargo) |
| @git | Git hooks and config protected (.git/hooks, .git/config), with worktree support |
| @lint/ts | TypeScript/JavaScript lint configs protected |
| @lint/go | Go lint configs protected |
| @lint/python | Python lint configs protected |
| @lint/all | All lint presets combined |
| @all | Everything: @base, @caches, @git, @lint/all |

This task defines the data structures and registry for presets, NOT the expansion logic.

## Rationale

Before we can expand presets, we need a clean data model. Presets are hierarchical
(@all includes @lint/all which includes @lint/ts, etc.) and need careful design.

Presets are resolved at sandbox startup with access to:
- Effective working directory (for relative paths like .git/hooks)
- Home directory (for ~ expansion)
- Git worktree detection (for @git preset)
- Loaded config file paths (so @base can mark them read-only in sandbox)

## Implementation Details

Create preset.go with:

```go
// PresetPaths holds resolved paths for a preset
type PresetPaths struct {
    Ro      []string
    Rw      []string
    Exclude []string
}

// PresetContext provides information needed to resolve presets
type PresetContext struct {
    HomeDir      string
    WorkDir      string
    GitWorktree  string // empty if not in a worktree
    // LoadedConfigPaths are absolute paths to config files that were actually loaded
    // (global + project OR --config). Used by @base to protect sandbox config from
    // modification inside the sandbox (per SPEC security guarantees).
    LoadedConfigPaths []string
}

// Preset represents a built-in filesystem preset
type Preset struct {
    Name        string
    Description string
    Composite   bool   // true for @all, @lint/all (they expand sub-presets)
    // Resolve returns the paths for this preset
    // - ctx: provides home dir, work dir, git worktree info
    // - disabled: presets to skip (for !@preset negation support)
    // Simple presets ignore disabled; composite presets check it
    Resolve     func(ctx PresetContext, disabled map[string]bool) PresetPaths
}

// PresetRegistry holds all built-in presets
var PresetRegistry = map[string]*Preset{
    "@base":        {Name: "@base", Composite: false, ...},
    "@caches":      {Name: "@caches", Composite: false, ...},
    "@git":         {Name: "@git", Composite: false, ...},
    "@lint/ts":     {Name: "@lint/ts", Composite: false, ...},
    "@lint/go":     {Name: "@lint/go", Composite: false, ...},
    "@lint/python": {Name: "@lint/python", Composite: false, ...},
    "@lint/all":    {Name: "@lint/all", Composite: true, ...},  // expands lint/*
    "@all":         {Name: "@all", Composite: true, ...},       // expands everything
}
```

**Two types of presets:**
1. **Simple presets** (@base, @caches, @git, @lint/*): Return paths directly, ignore `disabled`
2. **Composite presets** (@all, @lint/all): Expand sub-presets, checking `disabled` map

For composite presets, Resolve() iterates sub-presets and skips any in the disabled map.

## Files to Create
- cmd/agent-sandbox/preset.go - preset data structures and registry
- cmd/agent-sandbox/preset_test.go - tests

## Key Invariants
- Preset names always start with @ 
- PresetRegistry is immutable after initialization
- Users cannot define custom presets (per SPEC)
- Preset resolution is deterministic given the same context

## Acceptance Criteria

1. Preset struct defined with Name, Description, and Resolve function
2. PresetContext struct defined with HomeDir, WorkDir, GitWorktree, LoadedConfigPaths
3. PresetPaths struct defined with Ro, Rw, Exclude string slices
4. PresetRegistry map contains entries for all 8 presets
5. Registry is read-only (package-level var, no setters)
6. Tests verify registry contains expected presets
7. Tests verify preset names all start with @
