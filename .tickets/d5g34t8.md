---
schema_version: 1
id: d5g34t8
status: closed
closed: 2026-01-09T01:40:12Z
blocked-by: []
created: 2026-01-08T22:40:41Z
type: task
priority: 1
---
# Config: Fix Filesystem Array Merge Semantics

## Background & Context

Per SPEC.md Config Merging section:
> **Filesystem arrays (presets, ro, rw, exclude):** Merged (concatenated), then 
> specificity rules applied.

The current mergeConfigs implementation REPLACES filesystem arrays rather than 
concatenating them:

```go
// CURRENT (WRONG):
if len(override.Filesystem.Ro) > 0 {
    result.Filesystem.Ro = override.Filesystem.Ro  // replaces!
}
```

This should be:
```go
// CORRECT:
result.Filesystem.Ro = append(result.Filesystem.Ro, override.Filesystem.Ro...)
```

## Rationale

The merge semantics are critical for the layered configuration model. A user's 
project config should ADD to the global config's paths, not replace them. For 
example:

Global config: ro: ["~/secrets"]
Project config: ro: ["./sensitive"]  
Expected result: ro: ["~/secrets", "./sensitive"]

Current result: ro: ["./sensitive"] (WRONG - global path lost!)

## Implementation Details

Update mergeConfigs() to use append() for all filesystem arrays:
- Presets (but note: presets have special !@preset negation handling later)
- Ro
- Rw  
- Exclude

## Files to Modify
- cmd/agent-sandbox/config.go - fix mergeConfigs function
- cmd/agent-sandbox/config_test.go - add tests for concatenation behavior

## Key Invariants
- Arrays are concatenated, not replaced
- Order matters: base paths first, then override paths (for specificity tie-breaking)
- Empty arrays in override should not affect base arrays

## Acceptance Criteria

1. Filesystem.Ro arrays from multiple config layers are concatenated
2. Filesystem.Rw arrays from multiple config layers are concatenated
3. Filesystem.Exclude arrays from multiple config layers are concatenated
4. Filesystem.Presets arrays from multiple config layers are concatenated
5. Order preserved: global paths, then project paths, then CLI paths
6. Empty override arrays don't affect base arrays
7. Tests verify multi-layer concatenation scenarios
