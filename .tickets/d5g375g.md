---
schema_version: 1
id: d5g375g
status: closed
closed: 2026-01-09T03:36:54Z
blocked-by: []
created: 2026-01-08T22:45:42Z
type: task
priority: 1
---
# Command Wrappers: Binary Discovery and Path Resolution

## Background & Context

Per TECHNICAL_STEERING.md Command Wrapper Implementation:
> **Wrapper mechanism:** All paths to the binary are discovered (e.g., /usr/bin/git,
> /bin/git, /usr/local/bin/git) and symlinks resolved. For blocking (false), a 
> blocker is mounted over all locations.

Before we can wrap or block commands, we need to find ALL locations where the
binary exists, including symlinks.

## Rationale

Users might invoke commands via different paths:
- /usr/bin/git
- /bin/git (often symlink to /usr/bin/git)
- ~/bin/git (user's custom)

If we only block /usr/bin/git, /bin/git bypass would work. We must discover
and handle ALL paths to effectively wrap/block a command.

## Implementation Details

```go
// BinaryLocations finds all locations of a binary and resolves symlinks
func BinaryLocations(name string, env map[string]string) ([]BinaryPath, error) {
    var result []BinaryPath
    seenPath := make(map[string]bool) // Track candidate paths to avoid duplicates
    
    // Get PATH directories
    pathEnv := env["PATH"]
    dirs := filepath.SplitList(pathEnv)
    
    for _, dir := range dirs {
        candidate := filepath.Join(dir, name)

        if seenPath[candidate] {
            continue
        }
        seenPath[candidate] = true
        
        // Check if file exists and is executable
        info, err := os.Lstat(candidate)
        if err != nil {
            continue // Not found in this dir
        }
        
        if !isExecutable(info) {
            continue
        }
        
        // Resolve symlinks to find real binary
        resolved, err := filepath.EvalSymlinks(candidate)
        if err != nil {
            continue // Broken symlink
        }

        result = append(result, BinaryPath{
            Path:     candidate,
            Resolved: resolved,
            IsLink:   candidate != resolved,
        })
    }
    
    return result, nil
}

type BinaryPath struct {
    Path     string // Original path (e.g., /bin/git)
    Resolved string // Real binary (e.g., /usr/bin/git)
    IsLink   bool   // True if Path is a symlink
}
```

**Edge cases:**
- Multiple symlinks pointing to same binary
- Relative symlinks
- Circular symlinks (handled by EvalSymlinks)
- Non-executable files with matching name

## Files to Create
- cmd/agent-sandbox/wrapper.go - binary discovery
- cmd/agent-sandbox/wrapper_test.go - tests

## Key Invariants
- All PATH directories searched
- Symlinks resolved to real binary
- Non-executable files ignored
- Broken symlinks ignored (no error)
- Duplicate PATH entries handled deterministically (no duplicate candidate paths)

## Acceptance Criteria

1. Finds all PATH locations of a binary
2. Resolves symlinks to real binary path
3. Tracks which paths are symlinks vs direct
4. Ignores non-executable files
5. Handles broken symlinks gracefully
6. Returns empty list if binary not found (no error)
7. Works with multiple symlinks to same target
8. Tests with mock PATH and filesystem
