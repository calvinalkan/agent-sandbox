#!/bin/bash
# Sandbox git wrapper - blocks file restoration commands

blocked() {
  echo "sandbox: blocked '$1'" >&2
  echo "This is a protected operation. Do NOT attempt workarounds." >&2
  echo "If essential, ask the operator to run this command outside the sandbox." >&2
  if [[ -n "$2" ]]; then
    echo "" >&2
    echo "=== CRITICAL WARNING ===" >&2
    echo "$2" >&2
    echo "========================" >&2
  fi
  exit 1
}

case "$1" in
  checkout)
    # Block entirely - use 'git switch' for branches instead
    blocked "git checkout" "GIT CHECKOUT IS FORBIDDEN and will cause lost work!
Do NOT modify untracked files or changes you did not make, EVER.
Use 'git switch <branch>' to switch branches instead."
    ;;
  restore)
    # Block all git restore (it only restores files, no other use)
    blocked "git restore"
    ;;
  reset)
    # Block: git reset --hard (overwrites working tree)
    for arg in "$@"; do
      if [[ "$arg" == "--hard" ]]; then
        blocked "git reset --hard"
      fi
    done
    ;;
  clean)
    # Block: git clean -f (deletes untracked files)
    for arg in "$@"; do
      if [[ "$arg" == "-f" || "$arg" == "--force" || "$arg" =~ ^-[a-zA-Z]*f ]]; then
        blocked "git clean -f"
      fi
    done
    ;;
  checkout-index)
    # Block: git checkout-index (low-level file restoration)
    blocked "git checkout-index"
    ;;
esac

# Auto-skip GPG signing for commits (agents can't sign)
if [[ "$1" == "commit" ]]; then
  # Block --no-verify/-n (skips pre-commit hooks)
  for arg in "$@"; do
    if [[ "$arg" == "--no-verify" || "$arg" == "-n" ]]; then
      blocked "git commit --no-verify" "Skipping pre-commit hooks is forbidden.
Fix the issues that the hooks are catching instead of bypassing them."
    fi
  done
  exec /usr/bin/git commit --no-gpg-sign "${@:2}"
fi

exec /usr/bin/git "$@"
